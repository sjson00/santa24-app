<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> <!-- 뷰포트 메타 태그 -->
    <title>산타마리24의원 접수</title>

    <style>
        body {
            font-family: Arial, sans-serif;
            background: #E3F2FD;
            margin: 0;
            padding: 0;
        }
        .container {
            display: flex;
            max-width: 900px;
            margin: 40px auto;
            background: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .form-container {
            flex: 1;
            padding-right: 20px;
        }
        .patient-list {
            width: 400px;
            padding: 10px;
            background: #F1F8E9;
            border-radius: 8px;
            max-height: 400px;
            overflow-y: auto;
            display: none;
        }
        h2 {
            text-align: center;
            color: #1E88E5;
            cursor: pointer;
            font-size: 2em; /* 헤더 크기 증가 */
        }
        .notice {
            margin: 10px 0;
            text-align: center;
            color: #FF5722;
            font-size: 1.5em; /* 글자 크기 증가 */
        }
        input, textarea {
            width: 100%;
            padding: 12px;
            margin-top: 10px;
            border: 1px solid #ccc;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 1.2em; /* 입력 글자 크기 증가 */
        }
        .gender-container {
            display: flex;
            justify-content: center;
            margin-top: 10px;
        }
        .gender-container label {
            margin: 0 20px;
            font-size: 1.2em; /* 모바일에서 글자 크기 증가 */
        }
        .gender-container input {
            transform: scale(1.5);
            margin-right: 5px;
        }
        button {
            margin-top: 16px;
            width: 100%;
            padding: 14px;
            background: #1E88E5;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.2em; /* 버튼 글자 크기 증가 */
        }
        button:hover {
            background: #1565C0;
        }
        .patient-item {
            border-bottom: 1px solid #ccc;
            padding: 8px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .patient-info {
            flex: 1;
            font-size: 14px;
        }
        .delete-button {
            background: #FF5722;
            border: none;
            color: white;
            border-radius: 8px;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 13px;
            width: 70px;
        }
        .confirmation {
            display: none;
            padding: 12px;
            background: #FFEB3B;
            border-radius: 8px;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%,-50%);
            z-index: 1000;
        }
        .login {
            display: none;
        }
        .loading {
            text-align: center;
            color: #666;
            margin: 10px 0;
        }
        .privacy-policy {
            cursor: pointer;
            color: #1E88E5;
            text-align: center;
            margin-top: 20px;
            font-size: 1.2em;
        }
        .privacy-content {
            display: none;
            margin-top: 10px;
            padding: 10px;
            background: #F1F8E9;
            border-radius: 8px;
        }

        /* 모바일 스타일 */
        @media (max-width: 600px) {
            .container {
                padding: 16px; /* 패딩을 줄여서 더 많은 공간 확보 */
            }
            h2 {
                font-size: 2.5em; /* 모바일에서 헤더 크기 증가 */
            }
            .notice, .gender-container label {
                font-size: 1.5em; /* 모바일에서 글자 크기 증가 */
            }
            input, textarea {
                font-size: 1.5em; /* 모바일에서 입력 글자 크기 증가 */
            }
        }
    </style>
</head>

<body>
<div class="container">
    <div class="form-container">
        <h2 id="title">산타마리24의원 온라인 접수</h2>
        <p class="notice">접수가 정상적으로 되었는지 확인을 위해<br>병원 도착 시 접수 상태를 꼭 확인해 주세요.</p>

        <div id="receptionControl" style="display:none;text-align:center;">
            <button type="button" id="toggleReception">접수 마감</button>
            <p id="receptionStatus" style="color:#D32F2F;display:none;font-size: 2em;">현재 온라인 접수가 중단되었습니다.</p> <!-- 크기 증가 -->
        </div>

        <form id="receptionForm">
            <input type="text" name="name" placeholder="이름" required>
            <input type="text" name="birthdate" placeholder="생년월일 (예: 990101)" required maxlength="6" pattern="\d{6}" title="6자리 숫자 형식(YYMMDD)로 입력해주세요." 
                   oninput="this.value = this.value.replace(/[^0-9]/g, '').slice(0, 6);"> <!-- 6자리 숫자만 입력 -->
            <div class="gender-container">
                <label><input type="radio" name="gender" value="남" required> 남</label>
                <label><input type="radio" name="gender" value="여" required> 여</label>
            </div>
            <textarea name="symptoms" placeholder="증상" required></textarea>
            <button type="submit">접수하기</button>
        </form>

        <div class="login" id="loginSection">
            <h3>병원 직원 로그인</h3>
            <input type="text" id="username" placeholder="사용자 이름">
            <input type="password" id="password" placeholder="비밀번호">
            <button type="button" id="loginButton">로그인</button>
        </div>
    </div>

    <div class="patient-list" id="patientList">
        <h3>접수된 환자 목록</h3>
        <div class="loading" id="loadingMessage">데이터 불러오는 중...</div>
        <div id="patients"></div>
    </div>
</div>

<div class="confirmation" id="confirmationDialog">
    <p>삭제하시겠습니까?</p>
    <button id="confirmDelete">예</button>
    <button id="cancelDelete">아니오</button>
</div>

<!-- 개인정보 처리 방침 -->
<div class="privacy-policy" id="privacyPolicy">개인정보 처리방침</div>
<div class="privacy-content" id="privacyContent">
    <p>산타마리24의원 개인정보 처리 방침</p>
    <p>산타마리24의원(이하 "의원")은 환자의 개인정보를 중요시하며, 「개인정보 보호법」을 준수하기 위하여 노력하고 있습니다.</p>
    <!-- 생략된 개인정보 처리 방침 내용 -->
</div>

<script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
    import { getDatabase, ref, push, onValue, remove, set } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js';

    const firebaseConfig = {
        apiKey: "AIzaSyBJCjqUzPyaNqj0ZKUeKm1eJnm4dI4rwNc",
        authDomain: "santa-c17dd.firebaseapp.com",
        databaseURL: "https://santa-c17dd-default-rtdb.firebaseio.com",
        projectId: "santa-c17dd",
        storageBucket: "santa-c17dd.firebasestorage.app",
        messagingSenderId: "559395228968",
        appId: "1:559395228968:web:6a037c35531b9d744d141d"
    };

    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);
    const patientsRef = ref(database, 'patients');
    const receptionStatusRef = ref(database, 'receptionStatus'); // 접수 상태를 저장할 위치

    let receptionEnabled = true;
    let count = 0;
    let deleteKey = null;

    const confirmDeleteBtn = document.getElementById("confirmDelete");
    const cancelDeleteBtn = document.getElementById("cancelDelete");
    const receptionForm = document.getElementById("receptionForm");
    const receptionStatus = document.getElementById("receptionStatus");
    const toggleReception = document.getElementById("toggleReception");
    const loginButton = document.getElementById("loginButton");
    const patientList = document.getElementById("patientList");
    const loginSection = document.getElementById("loginSection");
    const title = document.getElementById("title");
    const patients = document.getElementById("patients");
    const confirmationDialog = document.getElementById("confirmationDialog");

    title.onclick = () => { if (++count === 3) loginSection.style.display = 'block'; };

    loginButton.onclick = () => {
        if (username.value === "1" && password.value === "1") {
            patientList.style.display = "block";
            receptionControl.style.display = "block";
            loadPatients();
        } else alert("로그인 실패");
    };

    // 접수 상태 가져오기
    onValue(receptionStatusRef, snapshot => {
        receptionEnabled = snapshot.val() !== null ? snapshot.val() : true; // 접수 상태 설정
        checkReceptionStatus(); // UI 업데이트
    });

    toggleReception.onclick = () => {
        receptionEnabled = !receptionEnabled; // 상태를 토글
        console.log('현재 접수 상태:', receptionEnabled); // 상태 로그
        checkReceptionStatus(); // UI 업데이트
        set(receptionStatusRef, receptionEnabled) // Firebase에 상태 저장
            .then(() => {
                console.log('Firebase에 상태 저장 성공');
            })
            .catch(error => {
                console.error('Firebase에 상태 저장 실패:', error);
            });
    };

    function checkReceptionStatus() {
        if (!receptionEnabled) {
            receptionForm.style.pointerEvents = "none";
            receptionForm.style.opacity = "0.5";
            receptionStatus.style.display = "block";
            toggleReception.innerText = "접수 시작";
        } else {
            receptionForm.style.pointerEvents = "auto";
            receptionForm.style.opacity = "1";
            receptionStatus.style.display = "none";
            toggleReception.innerText = "접수 마감";
        }
    }

    window.onload = checkReceptionStatus;

    receptionForm.onsubmit = e => {
        e.preventDefault();
        if (!receptionEnabled) {
            return alert("현재 접수가 중단되었습니다.");
        }
        push(patientsRef, {
            name: receptionForm.name.value,
            birthdate: receptionForm.birthdate.value,
            gender: receptionForm.gender.value,
            symptoms: receptionForm.symptoms.value,
            timestamp: new Date().toISOString()
        });
        alert("접수 완료");
        receptionForm.reset();
    };

    function loadPatients() {
        onValue(patientsRef, s => {
            patients.innerHTML = "";
            s.forEach(c => {
                const d = c.val();
                patients.innerHTML += `
                <div class="patient-item">
                    <div class="patient-info">
                        <b>${d.name}</b> / ${d.birthdate} / ${d.gender}<br>
                        증상: ${d.symptoms}
                    </div>
                    <button class="delete-button" onclick="confirmDelete('${c.key}')">삭제</button>
                </div>`;
            });
        });
    }

    window.confirmDelete = (key) => {
        deleteKey = key;
        confirmationDialog.style.display = "block";
        confirmDeleteBtn.focus();
    };

    confirmDeleteBtn.onclick = () => {
        if (!deleteKey) return;
        const r = ref(database, 'patients/' + deleteKey);
        remove(r);
        confirmationDialog.style.display = "none";
        deleteKey = null;
    };

    cancelDeleteBtn.onclick = () => {
        confirmationDialog.style.display = "none";
        deleteKey = null;
    };

    document.addEventListener('keydown', e => {
        if (!deleteKey) return;
        if (e.key === "Enter" || e.key === " ") {
            e.preventDefault();
            confirmDeleteBtn.click();
        }
        if (e.key === "Escape") {
            e.preventDefault();
            cancelDeleteBtn.click();
        }
    });

    // 개인정보 처리방침 클릭 시
    document.getElementById('privacyPolicy').onclick = () => {
        const privacyContent = document.getElementById('privacyContent');
        if (privacyContent.style.display === "none" || privacyContent.style.display === "") {
            privacyContent.style.display = "block";
        } else {
            privacyContent.style.display = "none";
        }
    };
</script>
</body>
</html>
